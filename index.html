<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>EDC complain Admin Pannel</title>
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
body { padding: 20px; background: #eef6ff; font-family: Arial, sans-serif; }
h2 { text-align: center; margin-bottom: 20px; }
.filters { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
select, button, input { padding: 6px 10px; border-radius: 5px; border: 1px solid #ccc; }
button { background: #007bff; color: white; cursor: pointer; }
button:hover { background: #0056b3; }

.status-red { color: white; background: #dc3545; font-weight: bold; border-radius: 5px; padding: 2px 5px; }
.status-green { color: white; background: #28a745; font-weight: bold; border-radius: 5px; padding: 2px 5px; }
.status-orange { color: white; background: #fd7e14; font-weight: bold; border-radius: 5px; padding: 2px 5px; }

#loginBox { max-width: 350px; margin: 100px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
#loginBox h3 { margin-bottom: 15px; }
#logoutBtn { background: #dc3545; color: white; margin-left: 10px; }
#logoutBtn:hover { background: #b02a37; }


/* ‚úÖ Fix ‚Äú‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‚Äù column width and text wrapping */
/* ‚úÖ Fix all column widths to prevent stretching */
#complaintsTable {
  table-layout: fixed;
  width: 100%;
}

#complaintsTable th,
#complaintsTable td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

table {
  font-size: 12px; /* ‡¶ö‡¶æ‡¶á‡¶≤‡ßá 10px ‡¶¨‡¶æ 11px ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® */
}

/* ‡¶∂‡ßÅ‡¶ß‡ßÅ table body-‡¶è‡¶∞ text ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶§‡ßá */
table tbody td {
  font-size: 13px;
}

/* ‡¶∂‡ßÅ‡¶ß‡ßÅ table head-‡¶è‡¶∞ text ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶§‡ßá */
table thead th {
  font-size: 14px;
}

/* Optional: adjust widths per column */
#complaintsTable th:nth-child(1), #complaintsTable td:nth-child(1) { width: 90px; }   /* ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ */
#complaintsTable th:nth-child(2), #complaintsTable td:nth-child(2) { width: 90px; }  /* ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ */
#complaintsTable th:nth-child(3), #complaintsTable td:nth-child(3) { width: 90px; }  /* ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® */
#complaintsTable th:nth-child(4), #complaintsTable td:nth-child(4) {   width: 250px;
  white-space: normal !important;
  word-wrap: break-word;
  overflow-wrap: break-word; }  /* ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶® */
#complaintsTable th:nth-child(5), #complaintsTable td:nth-child(5) { width: 120px; }  /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ */
#complaintsTable th:nth-child(6), #complaintsTable td:nth-child(6) { width: 90px; }  /* ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ */
#complaintsTable th:nth-child(7), #complaintsTable td:nth-child(7) {   width: 250px;
  white-space: normal !important;
  word-wrap: break-word;
  overflow-wrap: break-word; }  /* ‡¶ß‡¶∞‡¶£ */
#complaintsTable th:nth-child(8), #complaintsTable td:nth-child(8) {
  width: 250px;
  white-space: normal !important;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
#complaintsTable th:nth-child(9), #complaintsTable td:nth-child(9) { width: 130px; }  /* Completion */


#complaintsTable td:nth-child(8),
#complaintsTable th:nth-child(8) {
  width: 250px;                /* fixed width */
  white-space: normal !important; /* allow line wrapping */
  word-wrap: break-word;       /* break long words */
  overflow-wrap: break-word;   /* cross-browser wrapping */
  text-align: left;
  vertical-align: top;         /* grow vertically */
}

table.dataTable th,
table.dataTable td {
  max-width: 150px;  /* fixed width ‚Äî adjust as needed */
  width: 150px;      /* same fixed width */
  white-space: nowrap; 
  overflow: hidden;
  text-overflow: ellipsis; /* adds "..." when text is too long */
}

table.dataTable {
  table-layout: fixed; /* this is the key */
  width: 100% !important;
}

/* Mobile responsive card style */
@media (max-width: 1000px) {
  table#complaintsTable,
  table#complaintsTable thead,
  table#complaintsTable tbody,
  table#complaintsTable th,
  table#complaintsTable td,
  table#complaintsTable tr { display: block; }

  table#complaintsTable thead tr { display: none; }

  table#complaintsTable tr {
    background: #fff;
    margin-bottom: 15px;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }

  table#complaintsTable td {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border: none;
    border-bottom: 1px solid #eee;
    flex-wrap: wrap;
  }

  table#complaintsTable td:last-child { border-bottom: 0; }

  table#complaintsTable td:before {
    content: attr(data-label);
    font-weight: bold;
    flex-basis: 50%;
    text-align: left;
    margin-bottom: 3px;
  }

  table#complaintsTable td select { flex-basis: 45%; padding: 4px; border-radius:5px; }

  /* ‚úÖ Mobile version ‚Äú‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‚Äù wrapping */
  #complaintsTable td[data-label="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£"] {
    white-space: normal !important;
    word-wrap: break-word;
  }
}

/* Footer Style */
footer {
  background: #0d6efd;
  color: white;
  text-align: center;
  padding: 10px 5px;
  font-size: 15px;
  margin-top: auto;
  border-top: 2px solid #084298;
}
footer span { font-weight: bold; }
</style>
</head>
<body>


<!-- üîê Login Box -->
<div id="loginBox" style="display:none;">
  <h3>üîê Admin Login</h3>
  <p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®</p>
  <input type="email" id="emailInput" placeholder="Enter your email" class="form-control mb-2">
  <input type="password" id="passwordInput" placeholder="Enter your password" class="form-control mb-2">
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red; display:none;">‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</p>
</div>

<!-- üìã Admin Panel -->
<div id="adminPanel" style="display:none;">
  <h2>üìã EDC Connection Complain Tracking System</h2>

  <div class="filters">
    <label>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ:
      <select id="upazilaFilter">
        <option value="">‡¶∏‡¶¨ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</option>
        <option>‡¶Ø‡¶∂‡ßã‡¶∞ ‡¶∏‡¶¶‡¶∞</option>
        <option>‡¶∂‡¶æ‡¶∞‡ßç‡¶∂‡¶æ</option>
        <option>‡¶Æ‡¶®‡¶ø‡¶∞‡¶æ‡¶Æ‡¶™‡ßÅ‡¶∞</option>
        <option>‡¶ï‡ßá‡¶∂‡¶¨‡¶™‡ßÅ‡¶∞</option>
        <option>‡¶ù‡¶ø‡¶ï‡¶∞‡¶ó‡¶æ‡¶õ‡¶æ</option>
        <option>‡¶ö‡ßå‡¶ó‡¶æ‡¶õ‡¶æ</option>
        <option>‡¶¨‡¶æ‡¶ò‡¶æ‡¶∞‡¶™‡¶æ‡¶°‡¶º‡¶æ</option>
        <option>‡¶Ö‡¶≠‡¶Ø‡¶º‡¶®‡¶ó‡¶∞</option>
      </select>
    </label>

    <label>Completion Status:
      <select id="statusFilter">
        <option value="">‡¶∏‡¶¨</option>
        <option>Incomplete</option>
        <option>Ongoing</option>
        <option>Complete</option>
      </select>
    </label>
        <label>Complain Type:
      <select id="typeFilter">
        <option value="">‡¶∏‡¶¨</option>
        <option>‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡ßç‡¶≤‡ßã</option>
        <option>‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</option>
        <option>‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶á‡¶ï‡ßÅ‡¶á‡¶™‡¶Æ‡ßá‡¶£‡ßç‡¶ü (Wifi ‡¶∞‡¶æ‡¶â‡¶ü‡¶æ‡¶∞/ONU/‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤) ‡¶®‡¶∑‡ßç‡¶ü</option>
        <option>‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶á‡¶ï‡ßÅ‡¶á‡¶™‡¶Æ‡ßá‡¶£‡ßç‡¶ü (Wifi ‡¶∞‡¶æ‡¶â‡¶ü‡¶æ‡¶∞/ONU/‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤) ‡¶ö‡ßÅ‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</option>
              
      </select>
    </label>

    <button id="exportPDF">Export PDF</button>
    <button id="exportXLS">Export XLS</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <table id="complaintsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
        <th>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</th>
        <th>‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®/‡¶™‡ßå‡¶∞‡¶∏‡¶≠‡¶æ</th>
        <th>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</th>
        <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
        <th>‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
        <th>‡¶ß‡¶∞‡¶£</th>
        <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
        <th>Completion Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<script>
const API = "https://script.google.com/macros/s/AKfycbyedHMHbVetQEfLnRgivRgN95LmHv8JGlbgRtCS8-ZUbbsA5tm67FjLlQ1dhyW1TT7X/exec";
const allowedAdmins = [{ email: "mamun.eceku@gmail.com", password: "doict#2021" },
  { email: "habib.rahman@link3.net", password: "link3#2021" },
  { email: "abdulkarim13@gmail.com", password: "doict#2021" },
  { email: "shuvendu.halder@gmail.com", password: "doict#2021" },
  { email: "prolath38@gmail.com", password: "doict#2021" },
  { email: "ohidulice@gmail.com", password: "doict#2021" },
  { email: "ashraful.ru421@gmail.com", password: "doict#2021" },
  { email: "raju.doict@gmail.com", password: "doict#2021" },
  { email: "ahasanskabir@gmail.com", password: "doict#2021" },
  { email: "tutulbiswas@yahoo.com", password: "doict#2021" },
  { email: "doict.jashore@gmail.com", password: "doict#2021" }
];
let table;

// ‚úÖ Login Handling
function checkLogin() {
  const savedEmail = localStorage.getItem("adminEmail");
  const savedPass = localStorage.getItem("adminPass");
  const isValid = allowedAdmins.some(a => a.email.toLowerCase() === savedEmail && a.password === savedPass);
  if (isValid) { $("#loginBox").hide(); $("#adminPanel").show(); loadData(); }
  else { $("#loginBox").show(); $("#adminPanel").hide(); }
}

$("#loginBtn").click(() => {
  const email = $("#emailInput").val().trim().toLowerCase();
  const pass = $("#passwordInput").val().trim();
  const match = allowedAdmins.find(a => a.email.toLowerCase() === email && a.password === pass);
  if(match){ localStorage.setItem("adminEmail",email); localStorage.setItem("adminPass",pass); $("#loginError").hide(); checkLogin(); }
  else { $("#loginError").show(); }
});

$("#logoutBtn").click(()=>{ localStorage.removeItem("adminEmail"); localStorage.removeItem("adminPass"); location.reload(); });

// ‚úÖ Load Data
async function loadData() {
  const res = await fetch(API);
  const data = await res.json();
  data.forEach(item => { if(item.Timestamp) item.Timestamp = new Date(item.Timestamp).toLocaleDateString('bn-BD'); });

  if(table){ table.clear().rows.add(data).draw(); }
  else {
    table = new DataTable('#complaintsTable', {
      data: data,
      columns: [
        { data:'Timestamp', render:d=>`<td data-label="‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">${d}</td>` },
        { data:'upazila', render:d=>`<td data-label="‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ">${d}</td>` },
        { data:'union', render:d=>`<td data-label="‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®/‡¶™‡ßå‡¶∞‡¶∏‡¶≠‡¶æ">${d}</td>` },
        { data:'orgName', render:d=>`<td data-label="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®">${d}</td>` },
        { data:'phone', render:d=>`<td data-label="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤">${d}</td>` },
        { data:'connection', render:d=>`<td data-label="‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">${d}</td>` },
        { data:'type', render:d=>`<td data-label="‡¶ß‡¶∞‡¶£">${d}</td>` },
        { data:'details', render:d=>`<td data-label="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" style="white-space:normal;word-wrap:break-word;">${d}</td>` },
        { data:'CompletionStatus',
          render:(status,type,row)=>{
            let colorClass = status==='Incomplete'?'status-red':status==='Ongoing'?'status-orange':'status-green';
            return `<td data-label="Completion Status">
              <select class="${colorClass}" onchange="updateStatus(${row.rowIndex}, this.value, this)">
                <option value="Incomplete" ${status==='Incomplete'?'selected':''}>Incomplete</option>
                <option value="Ongoing" ${status==='Ongoing'?'selected':''}>Ongoing</option>
                <option value="Complete" ${status==='Complete'?'selected':''}>Complete</option>
              </select>
            </td>`;
          }
        }
      ]
    });
  }
}

// ‚úÖ Update Completion Status
async function updateStatus(rowIndex, newStatus, selectEl){
  let colorClass = newStatus==='Incomplete'?'status-red':newStatus==='Ongoing'?'status-orange':'status-green';
  selectEl.className = colorClass;

  try {
    const res = await fetch(API,{ method:"POST", body: JSON.stringify({action:"update", rowIndex, CompletionStatus:newStatus}) });
    const result = await res.text();
    if(result!=="Updated Successfully") alert("Backend update failed!");
    const rowData = table.rows().data().toArray().find(r=>r.rowIndex===rowIndex);
    if(rowData){ rowData.CompletionStatus = newStatus; table.rows().invalidate().draw(false); }
  } catch(err){ alert("Error updating backend!"); console.error(err);}
}

// ‚úÖ Filters
$('#upazilaFilter, #statusFilter,#typeFilter').on('change', function(){
  const upazila = $('#upazilaFilter').val();
  const status = $('#statusFilter').val();
  const type = $('#typeFilter').val();
  $.fn.dataTable.ext.search = [];
  $.fn.dataTable.ext.search.push(function(settings,data,dataIndex){
    const row = table.row(dataIndex).data();
    return (!upazila || row.upazila===upazila) && (!status || row.CompletionStatus===status)&&(!type||row.type==type);
  });
  table.draw();
});

// ‚úÖ Export PDF
$('#exportPDF').click(function(){
  if(!table || table.rows().count()===0){ alert("‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø PDF Export ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§"); return; }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  const head = [['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ','‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ','‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®/‡¶™‡ßå‡¶∞‡¶∏‡¶≠‡¶æ','‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®','‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤','‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞','‡¶ß‡¶∞‡¶£','‡¶¨‡¶ø‡¶¨‡¶∞‡¶£','Completion Status']];
  const body = table.rows({ search: 'applied' }).data().toArray().map(r=>[
    r.Timestamp,r.upazila,r.union,r.orgName,r.phone,r.connection,r.type,r.details,r.CompletionStatus
  ]);

  doc.autoTable({ head, body, startY:20, styles:{ fontSize:8, cellWidth:'wrap' } });
  doc.save('complaints.pdf');
  alert("‚úÖ PDF ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá Export ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
});

// ‚úÖ Export XLS
$('#exportXLS').click(function(){
  if(!table || table.rows().count()===0){ alert("‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø XLS Export ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§"); return; }

  const rows = table.rows({ search: 'applied' }).data().toArray();
  let xlsContent = `<table border="1"><tr>
    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</th><th>‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®/‡¶™‡ßå‡¶∞‡¶∏‡¶≠‡¶æ</th><th>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</th>
    <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶ß‡¶∞‡¶£</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>Completion Status</th>
  </tr>`;

  rows.forEach(r=>{
    xlsContent += `<tr>
      <td>${r.Timestamp}</td>
      <td>${r.upazila}</td>
      <td>${r.union}</td>
      <td>${r.orgName}</td>
      <td>${r.phone}</td>
      <td>${r.connection}</td>
      <td>${r.type}</td>
      <td>${r.details}</td>
      <td>${r.CompletionStatus}</td>
    </tr>`;
  });
  xlsContent += `</table>`;

  const blob = new Blob([xlsContent], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "complaints.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert("‚úÖ XLS ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá Export ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
});

// Auto reload
setInterval(() => location.reload(), 300000);
checkLogin();
</script>
  <footer>
    <span>Developed by Engr. Abdullah Al Mamun</span> |  Assistant Network Engineer, DOICT<br>
    IEB Membership No: <span>A23504</span> <span>Email: mamun.anedoict21@gmail.com</span>
  </footer>
</body>
</html>
