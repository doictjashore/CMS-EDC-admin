<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>EDC Complain Admin Panel</title>
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
body { padding: 20px; background: #eef6ff; font-family: Arial, sans-serif; }
h2 { text-align: center; margin-bottom: 20px; }
.filters { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
select, button, input { padding: 6px 10px; border-radius: 5px; border: 1px solid #ccc; }
button { background: #007bff; color: white; cursor: pointer; }
button:hover { background: #0056b3; }

.status-red { color: white; background: #dc3545; font-weight: bold; border-radius: 5px; padding: 2px 5px; }
.status-green { color: white; background: #28a745; font-weight: bold; border-radius: 5px; padding: 2px 5px; }
.status-orange { color: white; background: #fd7e14; font-weight: bold; border-radius: 5px; padding: 2px 5px; }

textarea { width:100%; min-height:40px; max-height:200px; resize:vertical; padding:5px; font-size:13px; box-sizing:border-box; }

#complaintsTable td, #complaintsTable th { word-wrap:break-word; overflow-wrap:break-word; }

#loginBox { max-width: 350px; margin: 100px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align:center; }
#loginBox h3 { margin-bottom: 15px; }
#logoutBtn { background: #dc3545; color: white; margin-left: 10px; }
#logoutBtn:hover { background: #b02a37; }

footer { background: #0d6efd; color: white; text-align: center; padding: 10px 5px; font-size: 15px; margin-top: 20px; border-top: 2px solid #084298; }
footer span { font-weight: bold; }

</style>
</head>
<body>

<!-- üîê Login Box -->
<div id="loginBox" style="display:none;">
  <h3>üîê Admin Login</h3>
  <input type="email" id="emailInput" placeholder="Email" class="form-control mb-2">
  <input type="password" id="passwordInput" placeholder="Password" class="form-control mb-2">
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red; display:none;">‚ùå Invalid login</p>
</div>

<!-- üìã Admin Panel -->
<div id="adminPanel" style="display:none;">
  <h2>üìã EDC Connection Complain Tracking System</h2>
  
  <div class="filters">
    <label>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ:
      <select id="upazilaFilter">
        <option value="">‡¶∏‡¶¨ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</option>
        <option>‡¶Ø‡¶∂‡ßã‡¶∞ ‡¶∏‡¶¶‡¶∞</option>
        <option>‡¶∂‡¶æ‡¶∞‡ßç‡¶∂‡¶æ</option>
        <option>‡¶Æ‡¶®‡¶ø‡¶∞‡¶æ‡¶Æ‡¶™‡ßÅ‡¶∞</option>
        <option>‡¶ï‡ßá‡¶∂‡¶¨‡¶™‡ßÅ‡¶∞</option>
        <option>‡¶ù‡¶ø‡¶ï‡¶∞‡¶ó‡¶æ‡¶õ‡¶æ</option>
        <option>‡¶ö‡ßå‡¶ó‡¶æ‡¶õ‡¶æ</option>
        <option>‡¶¨‡¶æ‡¶ò‡¶æ‡¶∞‡¶™‡¶æ‡¶°‡¶º‡¶æ</option>
        <option>‡¶Ö‡¶≠‡¶Ø‡¶º‡¶®‡¶ó‡¶∞</option>
      </select>
    </label>

    <label>Status:
      <select id="statusFilter">
        <option value="">‡¶∏‡¶¨</option>
        <option>Incomplete</option>
        <option>Ongoing</option>
        <option>Complete</option>
      </select>
    </label>

    <label>Complain Type:
      <select id="typeFilter">
        <option value="">‡¶∏‡¶¨</option>
        <option>‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡ßç‡¶≤‡ßã</option>
        <option>‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</option>
        <option>‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶á‡¶ï‡ßÅ‡¶á‡¶™‡¶Æ‡ßá‡¶£‡ßç‡¶ü (Wifi ‡¶∞‡¶æ‡¶â‡¶ü‡¶æ‡¶∞/ONU/‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤) ‡¶®‡¶∑‡ßç‡¶ü</option>
        <option>‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶á‡¶ï‡ßÅ‡¶á‡¶™‡¶Æ‡ßá‡¶£‡ßç‡¶ü (Wifi ‡¶∞‡¶æ‡¶â‡¶ü‡¶æ‡¶∞/ONU/‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤) ‡¶ö‡ßÅ‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</option>
      </select>
    </label>

    <button id="exportPDF">Export PDF</button>
    <button id="exportXLS">Export XLS</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <table id="complaintsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
        <th>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</th>
        <th>‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®</th>
        <th>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</th>
        <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
        <th>‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
        <th>‡¶ß‡¶∞‡¶£</th>
        <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
        <th>Completion Status</th>
        <th>Comment</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<footer>
  <span>Developed by: Department of ICT</span> | District Office, Jashore | <span>Information and Communication Technology Division</span>
</footer>

<script>
const API = "https://script.google.com/macros/s/AKfycbyYnIOd1_M-P7U2rBinNajNwYYEOR8UQJKstw5bFHsBzRh9vMuJAtv3zq9eyY4iUmktDw/exec"; // Change to your Google Apps Script URL
const allowedAdmins = [{email:"mamun.eceku@gmail.com",password:"doict#2021"}];
let table;

// ‚úÖ Login
function checkLogin(){
  const savedEmail = localStorage.getItem("adminEmail");
  const savedPass = localStorage.getItem("adminPass");
  const isValid = allowedAdmins.some(a=>a.email===savedEmail && a.password===savedPass);
  if(isValid){ $("#loginBox").hide(); $("#adminPanel").show(); loadData(); }
  else{ $("#loginBox").show(); $("#adminPanel").hide(); }
}

$("#loginBtn").click(()=>{
  const email = $("#emailInput").val().trim();
  const pass = $("#passwordInput").val().trim();
  const match = allowedAdmins.find(a=>a.email===email && a.password===pass);
  if(match){ localStorage.setItem("adminEmail",email); localStorage.setItem("adminPass",pass); $("#loginError").hide(); checkLogin(); }
  else{ $("#loginError").show(); }
});

$("#logoutBtn").click(()=>{ localStorage.removeItem("adminEmail"); localStorage.removeItem("adminPass"); location.reload(); });

// ‚úÖ Load data
async function loadData(){
  const res = await fetch(API);
  const data = await res.json();
  data.forEach(item=>{ if(item.Timestamp) item.Timestamp=new Date(item.Timestamp).toLocaleDateString('bn-BD'); });
  
  if(table){ table.clear().rows.add(data).draw(); }
  else {
    table = new DataTable('#complaintsTable',{
      data:data,
      columns:[
        { data:'Timestamp' },
        { data:'upazila' },
        { data:'union' },
        { data:'orgName' },
        { data:'phone' },
        { data:'connection' },
        { data:'type' },
        { data:'details', render:d=>`<td>${d}</td>` },
        { data:'CompletionStatus',
          render:(status,type,row)=>{
            let colorClass = status==='Incomplete'?'status-red':status==='Ongoing'?'status-orange':'status-green';
            return `<td><select class="${colorClass}" onchange="updateStatus(${row.rowIndex}, this)">
              <option value="Incomplete" ${status==='Incomplete'?'selected':''}>Incomplete</option>
              <option value="Ongoing" ${status==='Ongoing'?'selected':''}>Ongoing</option>
              <option value="Complete" ${status==='Complete'?'selected':''}>Complete</option>
            </select></td>`;
          }
        },
        { data:'comment',
          render:(comment,type,row)=>`<td><textarea maxlength="200" oninput="autoResize(this)" onblur="updateComment(${row.rowIndex}, this.value)">${comment||''}</textarea></td>`
        }
      ]
    });
  }
}

// ‚úÖ Auto resize textarea
function autoResize(el){ el.style.height='auto'; el.style.height=(el.scrollHeight)+'px'; }

// ‚úÖ Update Status
async function updateStatus(rowIndex, selectEl){
  const newStatus = selectEl.value;
  let colorClass = newStatus==='Incomplete'?'status-red':newStatus==='Ongoing'?'status-orange':'status-green';
  selectEl.className=colorClass;
  try {
    const res = await fetch(API,{ method:"POST", body: JSON.stringify({action:"update", rowIndex, CompletionStatus:newStatus}) });
    const result = await res.json();
    if(!result.success) alert("‚ö†Ô∏è Backend update failed!");
  } catch(err){ alert("‚ö†Ô∏è Error updating backend!"); console.error(err);}
}

// ‚úÖ Update Comment
async function updateComment(rowIndex, comment){
  try {
    const res = await fetch(API,{ method:"POST", body: JSON.stringify({action:"updateComment", rowIndex, comment}) });
    const result = await res.json();
    if(!result.success) alert("‚ö†Ô∏è Backend comment update failed!");
  } catch(err){ alert("‚ö†Ô∏è Error updating comment!"); console.error(err);}
}

// ‚úÖ Three filter handling
$('#upazilaFilter, #statusFilter, #typeFilter').on('change', function(){
  const upazila = $('#upazilaFilter').val();
  const status = $('#statusFilter').val();
  const type = $('#typeFilter').val();

  $.fn.dataTable.ext.search = [];
  $.fn.dataTable.ext.search.push(function(settings,data,dataIndex){
    const row = table.row(dataIndex).data();
    return (!upazila || row.upazila===upazila) &&
           (!status || row.CompletionStatus===status) &&
           (!type || row.type===type);
  });
  table.draw();
});

// ‚úÖ Export PDF
$('#exportPDF').click(function(){
  if(!table || table.rows().count()===0){ alert("‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø PDF Export ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§"); return; }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  const head = [['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ','‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ','‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®','‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®','‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤','‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞','‡¶ß‡¶∞‡¶£','‡¶¨‡¶ø‡¶¨‡¶∞‡¶£','Completion Status','Comment']];
  const body = table.rows({ search: 'applied' }).data().toArray().map(r=>[
    r.Timestamp,r.upazila,r.union,r.orgName,r.phone,r.connection,r.type,r.details,r.CompletionStatus,r.comment||''
  ]);

  doc.autoTable({ head, body, startY:20, styles:{ fontSize:8, cellWidth:'wrap' } });
  doc.save('complaints.pdf');
  alert("‚úÖ PDF ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá Export ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
});

// ‚úÖ Export XLS
$('#exportXLS').click(function(){
  if(!table || table.rows().count()===0){ alert("‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø XLS Export ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§"); return; }
  const rows = table.rows({ search: 'applied' }).data().toArray();
  let xlsContent = `<table border="1"><tr>
    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</th><th>‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®</th><th>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
    <th>‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶ß‡¶∞‡¶£</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>Completion Status</th><th>Comment</th>
  </tr>`;
  rows.forEach(r=>{
    xlsContent += `<tr>
      <td>${r.Timestamp}</td><td>${r.upazila}</td><td>${r.union}</td><td>${r.orgName}</td>
      <td>${r.phone}</td><td>${r.connection}</td><td>${r.type}</td><td>${r.details}</td>
      <td>${r.CompletionStatus}</td><td>${r.comment||''}</td>
    </tr>`;
  });
  xlsContent += `</table>`;
  const blob = new Blob([xlsContent], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "complaints.xls";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert("‚úÖ XLS ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá Export ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
});

checkLogin();
</script>
</body>
</html>
